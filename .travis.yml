dist: bionic
sudo: required
language: minimal

# Don't build tags
if: tag IS blank

stages:
  - name: build_short
    if: type = pull_request
  - name: build_full
    if: type != pull_request
  - name: archive
    if: type != pull_request

install:
  - scripts/configure_dev.sh -s -f
  - python3.7 -m venv venv
  - export PATH=`pwd`/venv/bin:${PATH}
  - pip3.7 install mulecli

jobs:
  allow_failures:
    - name: External ARM64 Deploy
    - name: External ARM64 Integration Test
    - name: External ARM Build
    - name: External ARM Deploy
    - name: Test Release Builds
  include:
    - stage: build_short
      os: linux
      name: Linux AMD64 Integration Test
      env:
        - SHORTTEST=-short
      arch: amd64
      script:
        - scripts/travis/travis_wait.sh 120 mule test-linux-amd64-integration
    - # same stage, parallel job
      name: Linux ARM64 Integration Test
      env:
        - SHORTTEST=-short
      os: linux
      arch: arm64
      script:
        - scripts/travis/travis_wait.sh 120 mule test-linux-arm64-integration
    - # same stage, parallel job
      os: osx
      osx_image: xcode11
      arch: amd64
      name: MacOS AMD64 Integration Test
      env:
        - SHORTTEST=-short
      go:
        - "1.12.17"
      go_import_path: github.com/algorand/go-algorand
      language: go
      script:
        - mule build-local
        - scripts/travis/travis_wait.sh 120 mule test-local-integration



    - stage: build_full
      os: linux
      name: Linux AMD64 Integration Test
      arch: amd64
      script:
        - scripts/travis/travis_wait.sh 120 mule test-linux-amd64-integration
    - # same stage, parallel job
      name: Linux ARM64 Integration Test
      os: linux
      arch: arm64
      script:
        - scripts/travis/travis_wait.sh 120 mule test-linux-arm64-integration
    - # same stage, parallel job
      os: osx
      osx_image: xcode11
      arch: amd64
      name: MacOS AMD64 Integration Test
      go:
        - "1.12.17"
      go_import_path: github.com/algorand/go-algorand
      language: go
      script:
        - mule build-local
        - scripts/travis/travis_wait.sh 120 mule test-local-integration



    - stage: archive
      os: linux
      name: Linux AMD64 Archive
      arch: amd64
      script:
        - mule build-linux-amd64
        - mule archive-local
    - # same stage, parallel job
      name: Linux ARM64 Archive
      os: linux
      arch: arm64
      script:
        - mule build-linux-arm64
        - mule archive-local
    - # same stage, parallel job
      os: osx
      osx_image: xcode11
      arch: amd64
      name: MacOS AMD64 Archive
      go:
        - "1.12.17"
      go_import_path: github.com/algorand/go-algorand
      language: go
      script:
        - mule archive-local
    - # same stage, parallel job
      name: External ARM Deploy
      os: linux
      env:
        - BUILD_TYPE: "external_build"
        - TARGET_PLATFORM: "linux-arm"
      addons:
        apt:
          packages:
            - awscli
      script:
        - scripts/travis/external_build.sh ./scripts/travis/deploy_packages.sh

# Don't rebuild libsodium every time
cache:
  directories:
    - crypto/lib

before_install:
  # Disable sometimes-broken sources.list in Travis base images
  - sudo rm -vf /etc/apt/sources.list.d/*

addons:
  apt:
    packages:
      - libboost-all-dev
      - fakeroot
      - rpm
      - libssl-dev
      - libffi-dev
      - python3.7-dev
  artifacts:
    s3_region: "us-east-1"
    paths:
      - $(git ls-files -o | grep -v crypto/libsodium-fork | grep -v crypto/lib/ | grep -v ^gen/ | grep -v swagger.json.validated | tr "\n" ":")

notifications:
  slack:
    secure: lBomhenfQvDzpUGxLadga188zavtGRr05GVWI6iI8ll/uwXewij8ginQ716Axg3pJvvRMNCuTNEmg0+fVlHf0JxTG3qWG35qOUexAHGcmimPD4ugmVkufua8Oc8Nl1LRSdWvbwIKvrAU1HDA37M5tCdEOm+Sf/OL72iVWbXhlHRvhdeiKHkbkcpI/15dOH4RpXuvPeYBrgcB2Ixs7gTSVyIAU458aT0JORu7expElQ+iBP9Kqze1V4dvjJyzHTgE01z2nyAm2Xpko447y//fYX2e20iDBE5S/GukaK/TeB3pD+FoC+Z2R7Gg1qA7a/gdGFbVgP12zWmzNaKVwY1YOvx8IIwP13XutioAE7bQbnHI1zGlQ+jxk3odWKZPhZSN/YvWD3i7g/xVksaTo++zwon2UlZ7x8LmKg1kOMeA3o2TUlzjQrwZZ4cB+4HqYHEqVdsSAadaMhKK82XE1OtGImdrIX1Y/02X2F/myJXwaE4Ap8smULHWGghCL/ALad+hdyE0K4/2SYDcoaOONgX9+VgaSEtYDO00Bt4/GMcuM+gwILsfCA9ZQuxCgIFEL1QWwDud8aGU1qF20yaimDlstlLnZXsv3Oli6r/CEEUVXltI5dkJyRd/jTlqWGjFGL8agGg34EPLP24Vn4h4QcIzoMfGWXkz2yrd6i0fvMAPXds=

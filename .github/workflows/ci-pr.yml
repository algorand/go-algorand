name: PR Tests
on:
  pull_request:
    branches:
      - master
      - 'rel/**'

env:
  CODECOV_TOKEN: "8b4a1f91-f154-4c26-b84c-c9aaa90159c6"  # Same public token from CircleCI config
  ALGORAND_DEADLOCK: enable
  KMD_NOUSB: True
  BUILD_TYPE: integration
  ALGOTEST: 1
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
  SKIP_GO_INSTALLATION: True

concurrency:
  group: pr-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  pull-requests: read
  contents: read

jobs:
  test:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: ./.github/actions/setup-go
        with:
          cache-prefix: test
      - name: Setup test environment
        uses: ./.github/actions/setup-test
      - name: Run tests
        run: |
          mkdir -p /home/runner/test_results/ubuntu-24.04_test
          # Profile the slow test with gotestsum
          gotestsum --format standard-quiet \
            --jsonfile /home/runner/test_results/ubuntu-24.04_test/testresults.json \
            -- -run TestRandomizedEncodingFullDiskState \
            -cpuprofile=/home/runner/test_results/ubuntu-24.04_test/cpu.prof \
            -memprofile=/home/runner/test_results/ubuntu-24.04_test/mem.prof \
            -tags "sqlite_unlock_notify sqlite_omit_load_extension" \
            ./agreement/
          # Generate text reports from profiles
          go tool pprof -top -cum /home/runner/test_results/ubuntu-24.04_test/cpu.prof > /home/runner/test_results/ubuntu-24.04_test/cpu_profile.txt || true
          go tool pprof -top -sample_index=alloc_space /home/runner/test_results/ubuntu-24.04_test/mem.prof > /home/runner/test_results/ubuntu-24.04_test/mem_profile.txt || true
      - name: Upload test artifacts to GitHub
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: test-profile-results-${{ github.run_id }}
          path: /home/runner/test_results
          retention-days: 7
